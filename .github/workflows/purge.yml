name: Purge jsDelivr Cache

on:
  push:
    branches:
      - main
    paths:
      - 'font/**'
      - 'meyveler/**'
      - 'music/**'

jobs:
  purge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # push i√ßin gerekli

      - name: Get changed files
        id: changes
        run: |
          echo "üìù Checking for changed files in the last commit..."
          CHANGED_FILES=$(git log -1 --name-only --pretty=format: | grep -E '^(font|meyveler|music)/' | sort -u)
          echo "Changed files: $CHANGED_FILES"

          # Dosya listesi logs/changed_files.txt i√ßine
          mkdir -p logs
          echo "$CHANGED_FILES" | tr ' ' '\n' > logs/changed_files.txt

          # Klas√∂r bazlƒ± liste i√ßin tmp dosya
          mkdir -p /tmp/dirs_to_purge
          for FILE in $CHANGED_FILES; do
            DIR=$(dirname "$FILE")
            echo "$DIR" >> /tmp/dirs_to_purge/dirs.txt
          done

          # Tekil klas√∂rleri output olarak ayarla
          CHANGED_DIRS=$(sort -u /tmp/dirs_to_purge/dirs.txt | tr '\n' ' ')
          echo "changed_dirs=$CHANGED_DIRS" >> $GITHUB_OUTPUT

      - name: Purge jsDelivr cache for changed folders
        if: steps.changes.outputs.changed_dirs != ''
        run: |
          echo "üßπ Purging jsDelivr cache for changed folders..."
          for DIR in ${{ steps.changes.outputs.changed_dirs }}; do
            PURGE_URL=$(echo "$DIR" | sed 's/ /%20/g')
            echo "üöÄ Purging cache for $DIR..."
            curl -s -X GET "https://purge.jsdelivr.net/gh/buraksariguzel81/buraksariguzeldev@main/$PURGE_URL/" \
            && echo "‚úÖ Cache purge completed for $DIR" \
            || echo "‚ö†Ô∏è Failed to purge $DIR"
          done

      - name: Commit changed files log
        if: steps.changes.outputs.changed_dirs != ''
        run: |
          echo "üíæ Committing changed_files.txt to repository..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add logs/changed_files.txt
          git diff --cached --quiet || git commit -m "Update changed_files.txt [skip ci]"
          git push

      - name: Check purge status
        run: |
          echo "‚úÖ jsDelivr cache purge workflow completed successfully!"
          echo "Repository: buraksariguzel81/buraksariguzeldev"
          echo "Branch: main"
          echo "Purged folders: ${{ steps.changes.outputs.changed_dirs }}"
          echo "Changed files saved at logs/changed_files.txt"
