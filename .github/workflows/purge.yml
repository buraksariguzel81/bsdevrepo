name: Purge jsDelivr Cache

on:
  push:
    branches:
      - main
    paths:
      - 'font/**'
      - 'meyveler/**'
      - 'music/**'

jobs:
  purge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get changed files
        id: changes
        run: |
          echo "üìù Checking for changed files in the last commit..."
          CHANGED_FILES=$(git log -1 --name-only --pretty=format: | grep -E '^(font|meyveler|music)/' | sort -u)
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"

      - name: Save changed files to a file
        if: steps.changes.outputs.changed_files != ''
        run: |
          echo "üíæ Saving changed files to logs/changed_files.txt..."
          mkdir -p logs
          echo "${{ steps.changes.outputs.changed_files }}" | tr ' ' '\n' > logs/changed_files.txt
          echo "Saved at logs/changed_files.txt"

      - name: Purge jsDelivr cache for changed folders
        if: steps.changes.outputs.changed_files != ''
        run: |
          echo "üßπ Purging jsDelivr cache for changed folders..."
          mkdir -p /tmp/dirs_to_purge
          for FILE in ${{ steps.changes.outputs.changed_files }}; do
            DIR=$(dirname "$FILE")
            echo "$DIR" >> /tmp/dirs_to_purge/dirs.txt
          done
          sort -u /tmp/dirs_to_purge/dirs.txt | while read DIR; do
            # URL encode bo≈üluk ve √∂zel karakterler i√ßin
            PURGE_URL=$(echo "$DIR" | sed 's/ /%20/g')
            echo "üöÄ Purging cache for $DIR..."
            curl -s -X GET "https://purge.jsdelivr.net/gh/buraksariguzel81/buraksariguzeldev@main/$PURGE_URL/" \
            && echo "‚úÖ Cache purge completed for $DIR" \
            || echo "‚ö†Ô∏è Failed to purge $DIR"
          done

      - name: Check purge status
        run: |
          echo "‚úÖ jsDelivr cache purge workflow completed successfully!"
          echo "Repository: buraksariguzel81/buraksariguzeldev"
          echo "Branch: main"
          echo "Purged folders:"
          sort -u /tmp/dirs_to_purge/dirs.txt
          echo "Changed files saved at logs/changed_files.txt"
