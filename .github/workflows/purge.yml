name: Purge jsDelivr Cache Including Deleted Files

on:
  push:
    branches:
      - main

jobs:
  purge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ge√ßmi≈ü commitleri g√∂rmemiz lazƒ±m

      - name: Set variables
        run: |
          REPO="buraksariguzel81/buraksariguzeldev"
          BRANCH="main"

      - name: Get changed & deleted files
        id: changes
        run: |
          echo "üìÇ Listing changed files..."
          # Son commit ile bir √∂nceki commit arasƒ±ndaki deƒüi≈üiklikler
          CHANGED=$(git diff --name-status HEAD~1 HEAD | grep -E "^(A|M|D)" | awk '{print $2}' | grep -E "^(font|assets|meyveler|music)/")
          echo "Changed files:"
          echo "$CHANGED"
          echo "files=$CHANGED" >> $GITHUB_OUTPUT

      - name: Purge jsDelivr cache for changed & deleted files
        run: |
          echo "üßπ Purging jsDelivr cache..."
          for FILE in ${{ steps.changes.outputs.files }}; do
            echo "üöÄ Purging $FILE..."
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X GET "https://purge.jsdelivr.net/gh/$REPO@$BRANCH/$FILE")
            if [[ "$RESPONSE" -eq 200 ]]; then
              echo "‚úÖ Purged $FILE successfully"
            else
              echo "‚ö†Ô∏è Failed to purge $FILE (HTTP status $RESPONSE)"
            fi
          done

      - name: Summary
        run: |
          echo "‚úÖ jsDelivr cache purge workflow completed!"
